<template>
  <v-layout justify-center wrap>
    <dialog-generic :data="data" />
    <v-flex xs12>
      <v-card class="elevation-3">
        <div class="card-bord-top">
          <v-card-title>
            <span class="title font-weight-light">{{this.cardTitle}}</span>
          </v-card-title>
          <v-card-text>
            <v-data-table :headers="headers" :items="results">
              <template v-slot:items="props">
                <td class="text-xs-left">{{ props.item.qtd }}</td>
                <td class="text-xs-left">{{ props.item.date }}</td>
                <td class="text-xs-right" style="width:5%;">
                  <v-btn
                    flat
                    icon
                    color="primary"
                    @click="goDownload(props.item.date,'csv', 'Result '+props.item.date+'.csv')"
                  >
                    <v-icon>cloud_download</v-icon>
                  </v-btn>
                </td>
              </template>
            </v-data-table>
          </v-card-text>
        </div>
      </v-card>
    </v-flex>
  </v-layout>
</template>

<script>
import { mapActions, mapState } from "vuex";
import { EventBus } from "@/services/event-bus.js";
import DialogGeneric from "@/components/organisms/Dialog/DialogGeneric";
export default {
  components: {
    DialogGeneric
  },
  computed: {
    ...mapState("product", ["product"]),
    ...mapState("auth", ["auth"])
  },
  created() {
    const selected = this.product.filter(
      rpa => rpa.id_user_product == this.$route.params.Rid
    );
    this.cardTitle = selected[0].name_rpa;
    const data = {
      token: this.auth.token,
      id_user: this.auth.id,
      id_rpa_type: this.$route.params.Rid
    };
    this.resultRpaUser(data)
      .then(res => {
        res.data.forEach(element => {
          if (element != "") {
            const item = {
              qtd: element.qtd,
              date: element.date_result.replace("T00:00:00.000Z", "")
            };
            this.results.push(item);
          }
        });
      })
      .catch(err => {
        //erro 500 -> auth expired
        EventBus.$emit("dialogGeneric", true);
      });
  },
  methods: {
    ...mapActions("rpa", ["resultRpaUser"]),
    ...mapActions("rpa", ["resultRpaUserSelected"]),
    goDownload(selected, fileType, fileName) {
      const data = {
        token: this.auth.token,
        id_user: this.auth.id,
        id_rpa_type: this.$route.params.Rid,
        date_selected: selected
      };
      this.resultRpaUserSelected(data)
        .then(res => {
          let resultRpa = "";
          res.data.forEach(element => {
            if (element != "") {
              resultRpa += element.result + "\r\n";
            }
          });
          var blob = new Blob([resultRpa], { type: fileType });
          var a = document.createElement("a");
          a.download = this.cardTitle + " - " + fileName;
          a.href = URL.createObjectURL(blob);
          a.dataset.downloadurl = [fileType, a.download, a.href].join(":");
          a.style.display = "none";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          setTimeout(function() {
            URL.revokeObjectURL(a.href);
          }, 1500);
        })
        .catch(err => {
          //erro 500 -> auth expired
          EventBus.$emit("dialogGeneric", true);
        });
    }
  },
  data() {
    return {
      cardTitle: "",
      data: {
        // success | information | error
        type: "information",
        title: "Session expired!",
        textButton: "log in",
        iconButton: "keyboard_backspace",
        sessionExpired: true,
        size: "290"
      },
      headers: [
        {
          text: "Quantify",
          align: "left",
          sortable: true,
          value: "name"
        },
        {
          text: "Date",
          align: "left",
          value: "dates"
        },
        {
          text: "",
          sortable: false,
          align: "",
          value: ""
        }
      ],
      results: []
    };
  }
};
</script>

<style>
</style>
